---
import { VIDEO_CONFIG } from '../config';
import './video.scss';

interface Props {
  /** URL de la vidéo desktop WebM */
  desktopWebm?: string;

  /** URL de la vidéo desktop MP4 (fallback Safari) */
  desktopMp4?: string;

  /** URL de la vidéo mobile WebM */
  mobileWebm?: string;

  /** URL de la vidéo mobile MP4 (fallback Safari mobile) */
  mobileMp4?: string;

  /** URL du poster haute qualité (WebP) */
  posterUrl?: string;

  /** Base64 du poster blur (LQIP) */
  posterBlurBase64?: string;

  /** Breakpoint pour passer en version mobile (défaut: 768px) */
  mobileBreakpoint?: number;

  /** URL de secours (YouTube/Cloudflare) si vidéo fail */
  fallbackUrl?: string;

  /** Timeout en ms avant de garder le poster si vidéo pas prête (défaut: 5000) */
  timeout?: number;
}

const config = { ...VIDEO_CONFIG, ...Astro.props };
---

<!-- Blur placeholder -->
<div
  class="video-blur"
  style={`background-image: url(${config.posterBlurBase64})`}
  aria-hidden="true"
>
</div>

<!-- Poster AVIF + WebP -->
<picture class="video-poster">
  <source
    media={`(max-width: ${VIDEO_CONFIG.BREAKPOINTS.mobile - 1}px)`}
    srcset={VIDEO_CONFIG.posters.mobile.avif}
    type="image/avif"
  />
  <source
    media={`(max-width: ${VIDEO_CONFIG.BREAKPOINTS.mobile - 1}px)`}
    srcset={VIDEO_CONFIG.posters.mobile.webp}
    type="image/webp"
  />

  <source
    media={`(min-width: ${VIDEO_CONFIG.BREAKPOINTS.mobile}px) and (max-width: ${VIDEO_CONFIG.BREAKPOINTS.tablet - 1}px)`}
    srcset={VIDEO_CONFIG.posters.tablet.avif}
    type="image/avif"
  />
  <source
    media={`(min-width: ${VIDEO_CONFIG.BREAKPOINTS.mobile}px) and (max-width: ${VIDEO_CONFIG.BREAKPOINTS.tablet - 1}px)`}
    srcset={VIDEO_CONFIG.posters.tablet.webp}
    type="image/webp"
  />

  <source
    media={`(min-width: ${VIDEO_CONFIG.BREAKPOINTS.tablet}px)`}
    srcset={VIDEO_CONFIG.posters.desktop.avif}
    type="image/avif"
  />
  <source
    media={`(min-width: ${VIDEO_CONFIG.BREAKPOINTS.tablet}px)`}
    srcset={VIDEO_CONFIG.posters.desktop.webp}
    type="image/webp"
  />

  <img
    src={VIDEO_CONFIG.posters.desktop.webp}
    alt="Hero background"
    loading="eager"
    decoding="async"
  />
</picture>

<!-- Vidéo -->
<video
  muted
  loop
  playsinline
  webkit-playsinline
  class="video-bg"
  preload="none"
  poster="data:,"
  data-fallback-url={config.fallbackUrl}
>
  <source
    src={config.mobileWebm}
    type="video/webm"
    media={`(max-width: ${config.mobileBreakpoint}px)`}
  />
  <source
    src={config.mobileMp4}
    type="video/mp4"
    media={`(max-width: ${config.mobileBreakpoint}px)`}
  />
  <source src={config.desktopWebm} type="video/webm" />
  <source src={config.desktopMp4} type="video/mp4" />
</video>
